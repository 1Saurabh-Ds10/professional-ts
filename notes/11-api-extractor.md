<p align='left'>
 <a href="./10-declaration-files.md">◀ Back: Declaration Files</a>
</p>

---

# API Extractor

[API extractor](https://api-extractor.com/) is a tool that's part of Microsoft's tech stack, and
in my opinion it's one of the most under-used and under-appreciated things in the TypeScript ecosystem.

## What problems does it solve?

- Generating API documentation
- Tells you if there are any changes in your API surface associated with a code change
- Allows you to provide multiple _variants_ of your public API surface, at various levels of release maturity (i.e., "beta")

It's also monorepo-friendly, which I'll go into in more detail in the **JavaScript and TypeScript Monorepos** course.

## Setup

```sh
# Install dependencies
yarn add -D @microsoft/api-extractor @microsoft/api-documenter

# Generate an initial config file: api-extractor.json
yarn api-extractor init
```

## Configuration: The basics

API extractor consumes _your tree of declaration files_ as an input. Let's make
a tsconfig specifically for this.

#### `tsconfig.apidocs.json`

```json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": ".dist-types",
    "declaration": true,
    "noEmit": false,
    "emitDeclarationOnly": true,
    "jsx": "react"
  },
  "include": ["src"]
}
```

and add this `.dist-types` folder to our gitignore

```diff
--- a/.gitignore
+++ b/.gitignore
@@ -115,5 +115,5 @@ dist
 .yarn/install-state.gz
 .pnp.*

+# Type information for api-extractor
+.dist-types
+# API report JSON generated by api-extractor
+temp
```

Let's try to tell typescript to build using this config file and see what happens

```sh
# build
tsc -P tsconfig.apidocs.json

# list contents of output folder
ls -p .dist-types
```

You should see something like

```
data/             type-guards.d.ts  ui/
index.d.ts        types.d.ts        utils/
```

Note the absence of `.js` files. This is _just the type information_

Next, we need to tell `api-extractor` about this. The whole point of this library is to consume a public API surface of some sort. We kind of have an app, and this is more traditionally done with a library, but there's still a lot of value here! We can create a dedicated entry point just for api-extractor

Create a new file `src/public-api-surface.ts` with the following content

#### [`src/public-api-surface.ts`](../src/public-api-surface.ts)

```ts
export {
  isChannel,
  isMessage,
  isTeam,
  isTypedArray,
} from './type-guards';
export { IChannel, IMessage, ITeam, IUser } from './types';

export { apiCall } from './utils/networking';
export { formatTimestamp } from './utils/date';

export {
  HTTPErrorKind,
  default as HTTPError,
} from './utils/http-error';

export {
  default as Deferred,
  RejectHandler,
  ResolveHandler,
} from './utils/deferred';
```

and build your declaration files again

```sh
# build
tsc -P tsconfig.apidocs.json

# list contents of output folder
ls -p .dist-types
```

You should see something like

```
data/                    type-guards.d.ts         utils/
index.d.ts               types.d.ts
public-api-surface.d.ts  ui/
```

Note the new `public-api-surface.d.ts`. This is the "main entry point" of our types, as far as api-extractor is concerned.

Open [`api-extractor.json`](../api-extractor.json) and look for `mainEntryPointFilePath`. Update it to point to your new declaration file

```diff
--- a/api-extractor.json
+++ b/api-extractor.json
@@ -45,7 +45,7 @@
    *
    * SUPPORTED TOKENS: <projectFolder>, <packageName>, <unscopedPackageName>
    */
-  "mainEntryPointFilePath": "<projectFolder>/lib/index.d.ts",
+  "mainEntryPointFilePath": "<projectFolder>/.dist-types/public-api-surface.d.ts",

   /**
```

and let's "extract the API surface"

```sh
yarn api-extractor run --local
```

You should see a few things happen

- you now have a `/etc` folder containing a markdown api report
- you have a `/temp` folder with a `.json` and `.md` version of your api report
- you'll see a bunch of warning messages in your console

You'll want to commit that `/etc` folder -- it's the "human-approved" API surface that
future changes will be compared to. Do not commit the `/temp` folder to git (it should be ignored, if you followed `.gitignore`-related instructions above).

Let's fix the errors in your console, it shouldn't take long

- `tsdoc-param-tag-missing-hyphen` wants `@param` JSDoc tags to look like

```
@param foo - description of foo
```

- `ae-missing-release-tag` wants everything that is exported to be marked as one of [four special JSDoc tags](https://api-extractor.com/pages/tsdoc/doc_comment_syntax/#release-tags) - `@public`, `@beta`, `@alpha` and `@internal` (in descending order of release maturity)

---

<p align='right'>
 <a href="./09-tests-for-types.md">Next: Tests for Types ▶</a>
</p>
